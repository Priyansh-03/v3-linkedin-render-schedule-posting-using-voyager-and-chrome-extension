<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Buddy - Login</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #333;
        }

        .card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        h1 {
            margin-bottom: 8px;
            font-weight: 600;
            color: #1a1a1a;
        }

        p {
            margin-top: 0;
            margin-bottom: 32px;
            color: #666;
            font-size: 0.95rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 12px 32px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 500;
            font-size: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
            width: 100%;
            box-sizing: border-box;
            border: none;
            margin-bottom: 12px;
        }

        .btn-linkedin {
            background-color: #0077b5;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 119, 181, 0.3);
        }

        .btn-linkedin:hover {
            background-color: #006097;
            box-shadow: 0 6px 20px rgba(0, 119, 181, 0.4);
            transform: translateY(-2px);
        }

        .btn-browser {
            background-color: #1a1a1a;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-browser:hover {
            background-color: #333;
            transform: translateY(-2px);
        }

        .btn svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        #status {
            margin-top: 20px;
            font-size: 0.9rem;
            color: #666;
            min-height: 20px;
        }
    </style>
</head>

<body>
    <div class="card">
        <h1>Welcome Back</h1>
        <p>Connect your LinkedIn account to get started with Post Buddy.</p>

        <button onclick="connectWithExtension()" class="btn btn-linkedin">
            <svg viewBox="0 0 24 24">
                <path
                    d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z" />
            </svg>
            Connect LinkedIn
        </button>

        <div id="status"></div>
    </div>

    <script>
        // IndexedDB Logic
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open("PostBuddyDB", 1);
                request.onerror = (event) => reject("IndexedDB error: " + event.target.errorCode);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    db.createObjectStore("session", { keyPath: "id" });
                };
                request.onsuccess = (event) => resolve(event.target.result);
            });
        }

        async function saveSession(cookies) {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(["session"], "readwrite");
                const store = transaction.objectStore("session");
                const request = store.put({ id: "linkedin_cookies", data: cookies });
                request.onsuccess = () => resolve();
                request.onerror = () => reject("Error saving session");
            });
        }

        async function saveProfile(profile) {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(["session"], "readwrite");
                const store = transaction.objectStore("session");
                const request = store.put({ id: "linkedin_profile", data: profile });
                request.onsuccess = () => resolve();
                request.onerror = () => reject("Error saving profile");
            });
        }

        async function getSession() {
            try {
                const db = await initDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(["session"], "readonly");
                    const store = transaction.objectStore("session");
                    const request = store.get("linkedin_cookies");
                    request.onsuccess = () => resolve(request.result?.data);
                    request.onerror = () => reject("Error fetching session");
                });
            } catch (e) {
                return null;
            }
        }

        // Auto-login check
        window.addEventListener('load', async () => {
            const cookies = await getSession();
            if (cookies) {
                window.location.href = "/compose";
            }
        });

        async function connectWithExtension() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = 'Checking LinkedIn session...<br><small>Make sure you are logged in to LinkedIn in this Chrome profile.</small>';

            try {
                const cookies = await requestCookiesFromExtension();
                if (!cookies?.li_at || !cookies?.JSESSIONID) {
                    statusDiv.innerHTML = `<span style="color: red">Could not fetch LinkedIn cookies. Please confirm you're logged in to LinkedIn and the extension is installed.</span>`;
                    return;
                }

                // Verify cookies with backend (optional but recommended)
                statusDiv.innerHTML = `<span style="color: blue">Verifying session...</span>`;
                const verifyResp = await fetch('/verify-cookies', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cookies })
                });
                const verifyData = await verifyResp.json();
                if (!verifyResp.ok || verifyData.status !== 'success') {
                    statusDiv.innerHTML = `<span style="color: red">LinkedIn session invalid. Please login to LinkedIn and try again.</span>`;
                    return;
                }

                statusDiv.innerHTML = `<span style="color: blue">Saving session...</span>`;
                await saveSession(cookies);
                await saveProfile(verifyData.profile || null);
                statusDiv.innerHTML = `<span style="color: green">Success! Redirecting...</span>`;
                setTimeout(() => window.location.href = "/compose", 800);
            } catch (error) {
                console.error(error);
                statusDiv.innerHTML = `<span style="color: red">Connection error: ${error.message}</span>`;
            }
        }

        function requestCookiesFromExtension(timeoutMs = 6000) {
            return new Promise((resolve, reject) => {
                let done = false;

                const timer = setTimeout(() => {
                    if (done) return;
                    done = true;
                    window.removeEventListener('message', onMessage);
                    reject(new Error('No response from extension. Please ensure the extension is installed and reloaded.'));
                }, timeoutMs);

                function onMessage(event) {
                    const data = event.data || {};
                    if (data?.source !== 'post-buddy-extension') return;
                    if (data?.type !== 'POST_BUDDY_LINKEDIN_COOKIES_RESULT') return;
                    if (done) return;
                    done = true;
                    clearTimeout(timer);
                    window.removeEventListener('message', onMessage);
                    if (!data.ok) reject(new Error(data.error || 'Failed to get cookies'));
                    else resolve(data.cookies);
                }

                window.addEventListener('message', onMessage);

                // Ask extension content-script (bridge.js) for cookies
                window.postMessage(
                    { source: 'post-buddy-page', type: 'POST_BUDDY_GET_LINKEDIN_COOKIES' },
                    '*'
                );
            });
        }
    </script>
</body>

</html>
